(()=>{var e={986:e=>{"use strict";e.exports=require("body-parser")},383:e=>{"use strict";e.exports=require("connect-flash")},142:e=>{"use strict";e.exports=require("dotenv")},632:e=>{"use strict";e.exports=require("ejs")},860:e=>{"use strict";e.exports=require("express")},508:e=>{"use strict";e.exports=require("express-session")},517:e=>{"use strict";e.exports=require("lodash")},185:e=>{"use strict";e.exports=require("mongoose")},488:e=>{"use strict";e.exports=require("mongoose-findorcreate")},511:e=>{"use strict";e.exports=require("passport")},743:e=>{"use strict";e.exports=require("passport-google-oauth20")},270:e=>{"use strict";e.exports=require("passport-local-mongoose")}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}(()=>{r(142).config();const e=r(860),t=(r(632),r(986)),s=(r(517),r(185)),i=r(508),o=r(511),n=r(383),a=r(270),u=r(743).Strategy,c=r(488),l=e();l.set("view engine","ejs"),l.use(t.urlencoded({extended:!0})),l.use(e.static(__dirname+"/public")),l.use(i({secret:process.env.SECRET,resave:!1,saveUninitialized:!1})),l.use(n()),l.use(o.initialize()),l.use(o.session()),s.connect("mongodb://127.0.0.1:27017/pawlibDB",{useNewUrlParser:!0});const g=new s.Schema({title:String,author:String,version:String,department:String,Link:String}),d=(s.model("Book",g),new s.Schema({title:String,faculty:String,books:[g]})),p=s.model("Department",d),m=new s.Schema({title:String,depts:[d]}),f=s.model("Faculty",m),h=new s.Schema({name:String,username:String,password:String,googleId:String,books:[g]});h.plugin(a),h.plugin(c);const S=s.model("User",h);o.use(S.createStrategy()),o.serializeUser((function(e,t){process.nextTick((function(){return t(null,{id:e.id,username:e.username})}))})),o.deserializeUser((function(e,t){process.nextTick((function(){return t(null,e)}))})),o.use(new u({clientID:process.env.CLIENT_ID,clientSecret:process.env.CLIENT_SECRET,callbackURL:"http://localhost:3000/auth/google/secrets",userProfileURL:"https://www.googleapis.com/oauth2/v3/userinfo"},(function(e,t,r,s){console.log(r),S.findOrCreate({googleId:r.id},(function(e,t){return s(e,t)}))}))),l.get("/auth/google",o.authenticate("google",{scope:["profile"]})),l.get("/auth/google/secrets",o.authenticate("google",{failureRedirect:"/login"}),(function(e,t){t.redirect("/home")})),l.get("/logout",((e,t)=>{e.logOut((function(e){console.log(e)})),t.redirect("/")})),l.get("/",(function(e,t){t.render("about")})),l.route("/home").get((async(e,t)=>{if(e.isAuthenticated()){let r=!1;"ebi1926b@gmail.com"===e.user.username&&(r=!0);const s=await f.find({});t.render("home",{faculties:s,manager:r})}else t.redirect("/login")})),l.route("/register").get(((e,t)=>{t.render("register")})).post(((e,t)=>{S.register({username:e.body.username},e.body.password,(function(r,s){r?(e.session.messages=r.message,t.redirect("/login")):o.authenticate("local")(e,t,(function(){t.redirect("/home")}))}))})),l.get("/login",((e,t)=>{var r=e.session.messages;e.session.valid=null,e.flash("Wrong Entry"),t.render("login",{passedVariable:r})})),l.post("/login",o.authenticate("local",{failureRedirect:"/login",failureMessage:!0}),(function(e,t){t.redirect("/home")})),l.get("/page/:pageid",(async(e,t)=>{if(e.isAuthenticated()){let r=!1;"ebi1926b@gmail.com"===e.user.username&&(r=!0);const s=e.params.pageid,i=await f.find({}),o=await p.findOne({_id:s});t.render("page",{faculties:i,department:o,manager:r})}else t.redirect("/login")})),l.route("/install").get(((e,t)=>{t.render("")})),l.get("/faculty",(async function(e,t){const r=await p.find().lean();t.json(r)})),l.listen(3e3,((e,t)=>{console.log("Server is running on port 3000")}))})()})();